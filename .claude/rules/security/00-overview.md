# セキュリティガイドライン概要

本プロジェクトはIPAの「安全なウェブサイトの作り方 第7版」に基づくセキュリティ対策を実施する。

## 対象脆弱性

以下の11種類の脆弱性に対する対策を必須とする。

| 分類 | 脆弱性 | 重要度 |
|------|-------|--------|
| インジェクション系 | SQLインジェクション | 高 |
| | OSコマンド・インジェクション | 高 |
| | ディレクトリ・トラバーサル | 高 |
| XSS系 | クロスサイト・スクリプティング（反射型・格納型・DOM-based） | 高 |
| CSRF・セッション系 | CSRF（クロスサイト・リクエスト・フォージェリ） | 高 |
| | セッション管理の不備 | 高 |
| HTTPヘッダ系 | HTTPヘッダ・インジェクション | 中 |
| | メールヘッダ・インジェクション | 中 |
| | クリックジャッキング | 中 |
| アクセス制御系 | アクセス制御・認可制御の欠落（IDOR） | 高 |
| 認証系 | パスワード管理・認証の不備 | 高 |

## セキュリティ原則

### 多層防御

根本的解決策と保険的対策を組み合わせ、多層防御を実現する。

### 入力値検証

外部からの入力値は常に検証し、ホワイトリスト方式を優先する。

### 出力エスケープ

出力時は必ずコンテキストに応じたエスケープ処理を行う。

### 最小権限の原則

データベース、ファイルシステム、APIアクセスは最小限の権限で行う。

### セキュアデフォルト

デフォルト設定は最も安全な状態とする。本番環境では `APP_DEBUG=false` を必須とする。

## Laravel固有の対策

Laravel は以下の機能により標準でセキュリティを提供する。

| 機能 | 対策内容 |
|------|----------|
| Eloquent ORM / Query Builder | SQLインジェクション防止（自動パラメータバインディング） |
| Blade `{{ }}` | XSS防止（自動HTMLエスケープ） |
| `@csrf` ディレクティブ | CSRF対策（自動トークン検証） |
| Hash ファサード | 安全なパスワードハッシュ（bcrypt/Argon2id） |
| Policy / Gate | 認可制御（アクセス制御） |
| Throttle ミドルウェア | レート制限（ブルートフォース対策） |

## React固有の対策

React のセキュリティ機能を適切に使用する。

| 機能 | 対策内容 |
|------|----------|
| JSX自動エスケープ | XSS防止（デフォルトでHTMLエスケープ） |
| DOMPurify | HTMLサニタイゼーション（`dangerouslySetInnerHTML` 使用時） |
| Axios `withCredentials` | CSRF対策（Cookie送信） |
| Axios `withXSRFToken` | CSRFトークン自動送信 |

## 禁止事項

以下のコーディングパターンは**全面禁止**とする。

- 文字列連結によるSQL構築
- `exec()`, `shell_exec()` 等のOS コマンド実行関数の使用（やむを得ない場合はエスケープ必須）
- Blade での `{!! !!}` によるエスケープなし出力（HTML許可が必要な場合はHTMLPurifier使用）
- React での `dangerouslySetInnerHTML` の生値使用（DOMPurify必須）
- `@inertiajs/react` の `useForm`（Laravel Precognition を使用）
- URLパラメータからのユーザーID取得（セッションから取得）
- 本番環境での `APP_DEBUG=true`

## セキュリティヘッダ必須設定

すべてのHTTPレスポンスに以下のヘッダを設定する。

| ヘッダ | 設定値 |
|-------|--------|
| `X-Frame-Options` | `SAMEORIGIN` |
| `X-Content-Type-Options` | `nosniff` |
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains` （本番環境） |
| `Referrer-Policy` | `strict-origin-when-cross-origin` |
| `Content-Security-Policy` | アプリケーション要件に応じて設定 |

## セキュリティレビュー

すべてのコード変更は以下の観点でレビューを行う。

1. 外部入力の検証が適切か
2. 出力エスケープが実施されているか
3. 認証・認可チェックが実装されているか
4. セキュアなAPI/関数を使用しているか
5. セキュリティヘッダが設定されているか
